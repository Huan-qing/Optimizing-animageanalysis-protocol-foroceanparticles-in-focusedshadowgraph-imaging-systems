close all
clear
path='D:\DQ\DQ\MS\research\optical experiment\blur\ring artifact\';
% path='F:\seg\subfolder\gain_T10\area\cast-4_T10_area\area500\';
FileList   = dir(fullfile(path, '*.tif*'));
for i=1:length(FileList)  
    image_name = FileList(i).name;
    grayImage=im2double((imread(strcat(path,image_name))));
figure;imshow(grayImage)
binary0=rem_simcan(grayImage,10/255);
%figure;imshow(binary0)
binary=edge(grayImage,'canny');
%figure;imshow(binary)
binary=imfill(binary,'holes');
binary=bwareafilt(binary,1);
%figure;imshow(binary)
binary=bwmorph(binary, 'bridge');
binary=imfill(binary,'holes');
%figure;imshow(binary)
% calculate the median of particle intensity
gray=grayImage;
% gray(binary==1)=0;
% sum(binary(:))>0.1*sum(binary0(:))
% refGrayVal=median(grayImage((binary==1)));
refGrayVal=mean(grayImage(binary==1));
% only keep those pixels with the particle, take all the background as 0
%figure;imshow(binary)
p = graydiffweight(grayImage,refGrayVal);
% %figure;imshow(p)
% calculate the weight based on pixel selected
W = graydiffweight(grayImage,binary) ;
%figure;imshow(log(W),[])

th = prctile(W(:),80);
% th=6;
newb=W>th; %2.5
%get the percentile that threshold located in 
% x = comp_percentile(W(:),th)
% get a threshold based on percentile

% newb=edge(log(W),'Canny');
%figure;imshow(newb)
% newb=bwareafilt(newb,1);
% %figure;imshow(newb)
% remove fluffy edge
newb=bwmorph(newb,'spur');
newb=imfill(newb,'holes');
% leave the largest particle in the ROI
newb=bwareafilt(newb,1);
% compare canny to weighted result
if sum(newb(:))<sum(binary(:))
    newb=binary;
end
%figure;imshow(newb)
gray(newb==0)=0;
%figure;imshow(gray)
k=bwperim(newb);
%figure;imshow(k)
if sum(newb(:))<0.1*size(grayImage,1)*size(grayImage,2)
    gray=grayImage;
end
figure;imshow(gray)
% imwrite(gray,['D:\DQ\DQ\MS\research\optical experiment\blur\ring artifact\success',num2str(i),'.tiff'])

end

%% new better? 8/1/2021

close all
clear
path='D:\DQ\DQ\MS\research\optical experiment\blur\ring artifact\';
% path='F:\seg\subfolder\gain_T10\area\cast-4_T10_area\area500\';
FileList   = dir(fullfile(path, '*.tif*'));
for i=1:length(FileList)  
    image_name = FileList(i).name;
    grayImage=im2double((imread(strcat(path,image_name))));
figure;imshow(grayImage)
binary0=rem_simcan(grayImage,10/255);
% figure;imshow(binary0)
binary=edge(grayImage,'canny');
% figure;imshow(binary)
binary=bwareafilt(binary,1);
binary=imfill(binary,'holes');

% figure;imshow(binary)
binary=bwmorph(binary, 'bridge');
binary=imfill(binary,'holes');
% figure;imshow(binary)
% calculate the median of particle intensity
gray=grayImage;
% gray(binary==1)=0;
% sum(binary(:))>0.1*sum(binary0(:))
% refGrayVal=median(grayImage((binary==1)));
refGrayVal=mean(grayImage(binary==1));
% only keep those pixels with the particle, take all the background as 0
% figure;imshow(binary)
p = graydiffweight(grayImage,refGrayVal);
% figure;imshow(p)
% calculate the weight based on pixel selected
W = graydiffweight(grayImage,binary) ;
% figure;imshow(log(W),[])

th = prctile(W(:),88);
% figure;imshow(th)
% th=6;
newb=W>th; %2.5
%get the percentile that threshold located in 
x = comp_percentile(W(:),th)
% get a threshold based on percentile

% newb=edge(log(W),'Canny');
% figure;imshow(newb)
% newb=bwareafilt(newb,1);
% figure;imshow(newb)
% remove fluffy edge
newb=bwmorph(newb,'spur');
newb=imfill(newb,'holes');
% leave the largest particle in the ROI
newb=bwareafilt(newb,1);
% compare canny to weighted result
if sum(newb(:))<sum(binary(:))
    newb=binary;
end
% figure;imshow(newb)
gray(newb==0)=0;
%  figure;imshow(gray)
% k=bwperim(newb);
%  figure;imshow(k)
if sum(newb(:))<0.1*size(grayImage,1)*size(grayImage,2)
    gray=grayImage;
end
 figure;imshow(gray)
% imwrite(gray,['D:\DQ\DQ\MS\research\optical experiment\blur\ring artifact\success',num2str(i),'.tiff'])

end
